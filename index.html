<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ONU Validator Pro - SmartOLT Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800 font-feature-settings-['cv11']">

    <div class="max-w-5xl mx-auto py-12 px-4">
        <div class="mb-10 text-center">
            <h1 class="text-4xl font-extrabold text-slate-900 mb-3 tracking-tight">ONU Validator <span class="text-blue-600">Pro</span></h1>
            <p class="text-slate-500 max-w-2xl mx-auto text-lg">Validasi otomatis data SmartOLT berdasarkan rumus <code class="bg-slate-200 px-2 py-0.5 rounded text-slate-700 font-bold">VLAN = ONU + 10</code>.</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                    <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                        <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                        Konfigurasi
                    </h3>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Target SVLAN</label>
                        <input type="text" id="targetSvlan" 
                               class="w-full px-4 py-2 bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all font-mono text-sm" 
                               placeholder="3131" value="3131">
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-semibold text-slate-700 mb-2">Upload File SmartOLT</label>
                        <div class="relative group">
                            <input type="file" id="fileInput" accept=".csv" 
                                   class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                            <div class="w-full px-4 py-8 bg-slate-50 border-2 border-dashed border-slate-300 rounded-xl flex flex-col items-center justify-center group-hover:border-blue-400 transition-colors">
                                <svg class="w-8 h-8 text-slate-400 group-hover:text-blue-500 mb-2 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                                <span class="text-xs font-medium text-slate-500 text-center px-2" id="fileNameDisplay">Klik untuk pilih file .csv</span>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col gap-3">
                        <button onclick="processCSV()" 
                                class="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition-all transform active:scale-95">
                            Proses & Validasi
                        </button>
                        
                        <button onclick="resetApp()" 
                                class="w-full bg-white hover:bg-slate-50 text-slate-600 border border-slate-200 font-semibold py-2 px-6 rounded-xl transition-all flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            Clear Data
                        </button>
                    </div>
                </div>

                <div class="bg-blue-600 p-6 rounded-2xl shadow-lg text-white">
                    <h4 class="font-bold mb-2">Info Rumus:</h4>
                    <ul class="mt-3 space-y-2 text-sm italic opacity-90 leading-relaxed">
                        <li>✔ VLAN = ONU + 10</li>
                        <li>✔ SVLAN = Target SVLAN</li>
                    </ul>
                </div>
            </div>

            <div class="lg:col-span-2">
                <div id="loadingState" class="hidden bg-white rounded-2xl p-12 text-center border border-slate-200 shadow-sm">
                    <div class="inline-block animate-spin w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mb-4"></div>
                    <p class="text-slate-500 font-medium">Menganalisis data batch...</p>
                </div>

                <div id="outputContainer" class="hidden space-y-6">
                    <div id="summaryCard" class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex justify-between items-center">
                        <div>
                            <p class="text-sm text-slate-500 font-medium">Total ONU Terdeteksi</p>
                            <h4 id="totalOnu" class="text-2xl font-bold text-slate-900">0</h4>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-slate-500 font-medium">SN Tidak Sesuai</p>
                            <h4 id="errorOnu" class="text-2xl font-bold text-red-600">0</h4>
                        </div>
                    </div>

                    <div id="errorTableCard" class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                            <h2 class="font-bold text-slate-800 flex items-center gap-3">
                                List SN yang Tidak Sesuai
                                <button onclick="copyAllSN()" id="copyBtn" 
                                        class="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition-all flex items-center group relative" 
                                        title="Copy semua SN ke clipboard">
                                    <svg id="copyIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                                    <svg id="checkIcon" class="w-5 h-5 text-emerald-500 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                                    <span class="absolute left-full ml-2 px-2 py-1 bg-slate-800 text-white text-[10px] rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Copy Semua SN</span>
                                </button>
                            </h2>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm" id="mainResultTable">
                                <thead>
                                    <tr class="text-slate-500 border-b border-slate-100">
                                        <th class="px-6 py-4 font-semibold uppercase tracking-wider text-[10px]">Serial Number</th>
                                        <th class="px-6 py-4 font-semibold uppercase tracking-wider text-[10px]">Keterangan Masalah</th>
                                    </tr>
                                </thead>
                                <tbody id="resultBody" class="divide-y divide-slate-50"></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="fullSuccess" class="hidden bg-emerald-50 border border-emerald-100 p-10 rounded-2xl text-center">
                        <div class="w-16 h-16 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                        <h3 class="text-xl font-bold text-emerald-800 mb-1">Batch Sempurna!</h3>
                        <p class="text-emerald-600/80">Semua ONU telah terkonfigurasi sesuai standar.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const outputContainer = document.getElementById('outputContainer');
        const loadingState = document.getElementById('loadingState');
        const resultBody = document.getElementById('resultBody');

        fileInput.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                fileNameDisplay.textContent = e.target.files[0].name;
                fileNameDisplay.classList.replace('text-slate-500', 'text-blue-600');
                fileNameDisplay.classList.add('font-bold');
            }
        });

        // FUNGSI COPY SN
        function copyAllSN() {
            const rows = document.querySelectorAll('#resultBody tr');
            if (rows.length === 0) return;

            let snList = [];
            rows.forEach(row => {
                // Kolom SN adalah td pertama
                const sn = row.querySelector('td:first-child').innerText.trim();
                snList.push(sn);
            });

            const textToCopy = snList.join('\n');
            
            navigator.clipboard.writeText(textToCopy).then(() => {
                // Feedback visual tombol
                const copyIcon = document.getElementById('copyIcon');
                const checkIcon = document.getElementById('checkIcon');
                
                copyIcon.classList.add('hidden');
                checkIcon.classList.remove('hidden');
                
                setTimeout(() => {
                    copyIcon.classList.remove('hidden');
                    checkIcon.classList.add('hidden');
                }, 2000);
            });
        }

        function resetApp() {
            fileInput.value = "";
            fileNameDisplay.textContent = "Klik untuk pilih file .csv";
            fileNameDisplay.classList.replace('text-blue-600', 'text-slate-500');
            fileNameDisplay.classList.remove('font-bold');
            outputContainer.classList.add('hidden');
            loadingState.classList.add('hidden');
            resultBody.innerHTML = "";
            document.getElementById('targetSvlan').value = "3131";
        }

        function processCSV() {
            const targetSvlan = document.getElementById('targetSvlan').value.trim();
            const file = fileInput.files[0];
            
            if (!file) {
                alert("Silakan pilih file CSV terlebih dahulu.");
                return;
            }

            loadingState.classList.remove('hidden');
            outputContainer.classList.add('hidden');

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    const data = results.data;
                    const invalidSNs = new Set();
                    const errorDetails = {};
                    const totalOnus = new Set();
                    let currentAllocated = null;

                    data.forEach(row => {
                        const sn = row['SN'] || row['Serial Number'] || row['ONU external ID'];
                        let allocated = row['Allocated ONU'];
                        const vlan = parseInt(row['Service port VLAN']);
                        const svlan = (row['Service port SVLAN'] || "").toString().replace('.0', '').trim();

                        if (!sn) return;
                        totalOnus.add(sn);

                        if (allocated) currentAllocated = parseInt(allocated);
                        
                        const expectedVlan = currentAllocated + 10;
                        const isVlanValid = (vlan === expectedVlan);
                        const isSvlanValid = (svlan === targetSvlan);

                        if (!isVlanValid || !isSvlanValid) {
                            invalidSNs.add(sn);
                            if (!errorDetails[sn]) errorDetails[sn] = new Set();
                            if (!isVlanValid) errorDetails[sn].add(`VLAN: ${vlan} (Harusnya ${expectedVlan})`);
                            if (!isSvlanValid) errorDetails[sn].add(`SVLAN: ${svlan || 'Kosong'} (Target ${targetSvlan})`);
                        }
                    });

                    renderResults(totalOnus.size, invalidSNs, errorDetails);
                }
            });
        }

        function renderResults(total, invalidSet, details) {
            loadingState.classList.add('hidden');
            outputContainer.classList.remove('hidden');
            
            document.getElementById('totalOnu').innerText = total;
            document.getElementById('errorOnu').innerText = invalidSet.size;

            resultBody.innerHTML = "";
            const errorTableCard = document.getElementById('errorTableCard');
            const fullSuccess = document.getElementById('fullSuccess');
            
            if (invalidSet.size > 0) {
                fullSuccess.classList.add('hidden');
                errorTableCard.classList.remove('hidden');
                
                invalidSet.forEach(sn => {
                    resultBody.innerHTML += `
                        <tr class="hover:bg-slate-50/80 transition-colors">
                            <td class="px-6 py-4 font-mono font-bold text-slate-900">${sn}</td>
                            <td class="px-6 py-4">
                                <div class="flex flex-wrap gap-2">
                                    ${Array.from(details[sn]).map(err => `
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-[11px] font-medium bg-red-100 text-red-700 border border-red-200">
                                            ${err}
                                        </span>
                                    `).join('')}
                                </div>
                            </td>
                        </tr>
                    `;
                });
            } else {
                errorTableCard.classList.add('hidden');
                fullSuccess.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>